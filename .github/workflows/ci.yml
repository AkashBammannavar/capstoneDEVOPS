name: CI Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-test-scan-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout code
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. Set up Docker
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    # 3. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 4. Build Images
    - name: Build Docker Images
      run: docker-compose build

    # 5. Run Containers (Test)
    - name: Run Containers
      run: docker-compose up -d

    # 6. Health Check
    - name: Health Check
      run: |
        sleep 10
        curl http://localhost:5000/health

    # 7. Security Scan (Trivy)
    - name: Trivy Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: backend_app
        format: table
        exit-code: 0

    # 8. Tag & Push Images
    - name: Tag and Push Backend Image
      run: |
        docker tag backend_app ${{ secrets.DOCKER_USERNAME }}/backend-app:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/backend-app:latest

    # 9. Deploy
    - name: Deploy to Server
      run: |
        docker-compose down
        docker-compose pull
        docker-compose up -d
